<!DOCTYPE html>
<html>
	<head>
		<title> YMAK - BLOG </title>
		<meta charset="UTF-8"/>
	    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
		<meta name="viewport" content="width=device-width, initial-scale=1"/>
		<meta name="author" content="ymark"/>
		<!-- Favicons -->
		<link rel="icon" href="/static/img/favicon.ico" />
		<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
		<!--[if lt IE 9]>
		  <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
		  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
		<![endif]-->
		<link rel="stylesheet" href="/static/css/bootstrap.edit.min.css" type="text/css" />
		<link rel="stylesheet" href="/static/fun/editor/wangEditor.min.css" type="text/css" />
		<link rel="stylesheet" href="/static/css/course-edit.css" type="text/css" />
	</head>

	<body>
		<div id="divEditor"> <p>请输入内容...</p> </div>
		<script src="/static/js/jquery-2.1.3.min.js"></script>
		<script src="/static/fun/editor/wangEditor.min.js"></script>
		<script src="/static/js/sea.js"></script>
		<script type="text/javascript">
			var editor = null ,
				objCatalog = null;
			// MENU 单击返回时被触发
			window.onReturn = function(){
				window.location.href = '/mcourse/list';
			}
			// MENU 单击目录时被触发
			window.onCatalog = function(){
				layer.msg('加载中', {icon: 16});
			}
			$(function(){	
				seajs.config({
				  // 设置路径，方便跨目录调用
				  paths: {
				  	'mjs' 	: '/static/m/js/' ,
				    'fjs' 	: '/static/fun/'  ,
				    'editor' 	: '/static/fun/editor/js',
				  },
				  // 设置别名，方便调用
				  alias: {
				    'jsmind'   			: 'fjs/jsmind/jsmind.js',
				    'jsminddraggable'	: 'fjs/jsmind/jsmind.draggable.js',
				    'ymark'	            : 'mjs/ymark.js',
				    'layer'             : 'fjs/layer/layer.js',
				    'layerstyle'		: 'fjs/layer/skin/layer.css',
				    'plupload'          : 'fjs/upload/plupload.full.min.js',
				    'tree' 				: 'fjs/tree/jstree.min.js',
				    'treestyle'			: 'fjs/tree/default/style.min.css',
				    'editorReturn' 		: 'editor/custom-menu.js'
				  }
				});
				loadEditor();
				objCatalog = catalog();
			});

			function loadEditor(){
				var domEditor = undefined;
				var catalogWidth = 0 ;
				objEditor = new wangEditor('divEditor');
		    	var uploaderInit = function(){
			    	seajs.use(['plupload'] ,function() { 		//加载自定义上传图片的功能
			            var btnId = objEditor.customUploadBtnId;
			            var containerId = objEditor.customUploadContainerId;
			            //实例化一个上传对象
			            var uploader = new plupload.Uploader({
			                browse_button: btnId,
			                url: '/fun/upload/editorimg',
			                flash_swf_url: '/static/fun/upload/Moxie.swf',
			                sliverlight_xap_url: '/static/fun/upload/Moxie.xap',
			                filters: {
			                    mime_types: [
			                        //只允许上传图片文件 （注意，extensions中，逗号后面不要加空格）
			                        { title: "图片文件", extensions: "jpg,gif,png,bmp" }
			                    ]
			                }
			            });
			            //存储所有图片的url地址
			            var urls = [];
			            //初始化
			            uploader.init();
			            //绑定文件添加到队列的事件
			            uploader.bind('FilesAdded', function (uploader, files) {
			                // 文件添加之后，开始执行上传
			                uploader.start();
			            });

			            //单个文件上传之后
			            uploader.bind('FileUploaded', function (uploader, file, responseObject) {
			                //注意，要从服务器返回图片的url地址，否则上传的图片无法显示在编辑器中
			                var url = eval('('+responseObject.response+')');
			                //先将url地址存储来，待所有图片都上传完了，再统一处理
			                urls.push(url.data);
			            });

			            //全部文件上传时候
			            uploader.bind('UploadComplete', function (uploader, files) {
			                // 用 try catch 兼容IE低版本的异常情况
			                try {
			                    //打印出所有图片的url地址
			                    $.each(urls, function (key, value) {
			                        // 插入到编辑器中
			                        objEditor.command(null, 'insertHtml', '<img src="' + value + '" style="max-width:100%;"/>');
			                    });
			                } catch (ex) {
			                    // 此处可不写代码
			                } finally {
			                    //清空url数组
			                    urls = [];
			                    // 隐藏进度条
			                    objEditor.hideUploadProgress();
			                }
			            });

			            // 上传进度条
			            uploader.bind('UploadProgress', function (uploader, file) {
			                // 显示进度条
			                objEditor.showUploadProgress(file.percent);
			            });
			    	});
		    	},
		    	loadPlugin = function(){
		    		seajs.use(['editorReturn'] ,function() {
		    			objEditor.create(); 
		    			domEditor = $('#divEditor');
		    			domEditor.show();
		    			offsetWidth();
		    		});
		    	},
		    	offsetWidth = function(){ // 自动计算宽度
		    		seajs.use(['ymark','layer' ,'layerstyle' ,'tree' ,'treestyle','jsmind','jsminddraggable'] ,function(aa) {
		    			objCatalog.loadHtml(function(){
		    				objCatalog.loadTree();
		    				catalogWidth = objCatalog.getWidth();
		    				domEditor.width($.getWidth() - catalogWidth);
		    			});
		    			
		    		});
		    	}
		    	objEditor.config.customUpload = true;  // 配置自定义上传
        		objEditor.config.customUploadInit = uploaderInit;  // 配置上传事件
        		objEditor.config.menus = ['menureturn', 'catalog', '|', 'bold', 'img', 'indent'];
		    	loadPlugin();
			}

			function catalog(){
				var domTree = null; 

				var data 	= [];
				var loadCatalog = function(callback){
					domTree = $('<div id="catalogTree" class="catalog-tree">2222</div>');
					$('#divEditor').parent('.wangEditor-container').append(domTree);
					if(callback) callback();
				} ,
				getData = function(){

				}
				getData();
				return {
					loadHtml : loadCatalog  ,
					loadTree : function(){
						domTree.jstree({
						  	core : {
							    animation : 0,
							    check_callback : true,
							    data : {
								    url : function (node) {return '/mcourse/nexus/list'; },
								    data : function (node) {return { 'id' : node.id }; }
								}
						  	},
						 	types : {"default" : {"icon" : "glyphicon glyphicon-tree-deciduous"} },
						  	contextmenu:{  
						        "items":{  
						            "create":null,
						            "rename":null,
						            "remove":null,
						            "ccp":null,
						            "addNode":{
						                "label":"添加子节点",  
						                "action":function(data){  
						                	console.log('addNode');
						                    console.log(data);
						                    var inst 	= jQuery.jstree.reference(data.reference),  
						                   		obj 	= inst.get_node(data.reference);
						                    console.log({"title":"新建“"+obj.text+"”的子菜单",url:"/accountmanage/createMenu?id="+obj.id,height:280,width:400});
						                }
						            },
						            "delNode":{
						                "label":"删除",
						                "action":function(data){  
						                    var inst = jQuery.jstree.reference(data.reference),  
						                    obj = inst.get_node(data.reference);  
						                    if(confirm("确定要删除此菜单？删除后不可恢复。")){  
						                        jQuery.get("/accountmanage/deleteMenu?id="+obj.id,function(dat){  
						                            if(dat == 1){  
						                                alert("删除菜单成功！");  
						                                jQuery("#"+treeid).jstree("refresh");  
						                            }else{  
						                                alert("删除菜单失败！");  
						                            }  
						                        });  
						                    }  
						                }  
						            },  
						            "edit":{  
						                "label":"编辑",  
						                "action":function(data){  
						                    var inst = jQuery.jstree.reference(data.reference),  
						                    obj = inst.get_node(data.reference);  
						                    dialog.show({"title":"编辑“"+obj.text+"”菜单",url:"/accountmanage/editMenu?id="+obj.id,height:280,width:400});  
						                }  
						            }
								}
						    },
						  	plugins : ["contextmenu", "search", "state", "types", "wholerow"] 
						});
					},
					getWidth : function(){return domTree.width() + 20; }
				}
			}
		</script>
	</body>
</html>
