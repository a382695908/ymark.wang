<!DOCTYPE html>
<html>
	<head>
		<title> YMAK - BLOG </title>
		<meta charset="UTF-8"/>
	    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
		<meta name="viewport" content="width=device-width, initial-scale=1"/>
		<meta name="author" content="ymark"/>
		<!-- Favicons -->
		<link rel="icon" href="/static/img/favicon.ico" />
		<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
		<!--[if lt IE 9]>
		  <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
		  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
		<![endif]-->
		<link rel="stylesheet" href="/static/css/bootstrap.edit.min.css" type="text/css" />
		<link rel="stylesheet" href="/static/fun/editor/wangEditor.min.css" type="text/css" />
		<link rel="stylesheet" href="/static/css/course-edit.css" type="text/css" />
	</head>

	<body>
		<div id="divEditor"> <p></p>{{ controller.model.content }} </div>
		<input type="hidden" id="uid" value="{{ controller.uid }}" />
		<div id="divCatalogForm">
			<form>
				<div class="form-group">
				    <label>父节点：</label> <span id="catalog_ptitle">信息系统项目管理师考试教程</span>
				</div>
				<div class="form-group">
				    <label>深度：</label> <span id="catalog_deep">1</span>
				</div>
			  <div class="form-group">
			    <label for="catalog_title">节点名称</label>
			    <input type="email" class="form-control" id="catalog_title">
			  </div>
			  <div class="form-group">
			    <label for="catalog_remark">备注</label>
			    <textarea class="form-control" id="catalog_remark" rows="3"></textarea>
			  </div>
			  <button type="button" class="btn btn-warning" id="catalog_btn_close">关闭</button>
			  <button type="button" class="btn btn-info" id="catalog_btn_submit">提交</button>
			  <button type="button" class="btn btn-primary" id="catalog_btn_submit_new">保存并新建</button>
			</form>
		</div>
		<div id="divBtnGroup">
			<button type="button" class="btn btn-primary" id="btnContentSaveQuick">快速保存</button>
			<button type="button" class="btn btn-info"  id="btnContentSave">保存</button>
		</div>
		<script src="/static/js/jquery-2.1.3.min.js"></script>
		<script src="/static/fun/editor/wangEditor.min.js"></script>
		<script src="/static/js/sea.js"></script>
		<script type="text/javascript">
			var objEditor	= null ,
				objCatalog 	= null ,
				objContent 	= null ;
			// MENU 单击返回时被触发
			window.onReturn = function(){
				window.location.href = '/mcourse/list';
			}
			// MENU 单击目录时被触发
			window.onCatalog = function(){
				layer.msg('加载中', {icon: 16});
			}
			$(function(){	
				seajs.config({
				  // 设置路径，方便跨目录调用
				  paths: {
				  	'mjs' 	: '/static/m/js/' ,
				    'fjs' 	: '/static/fun/'  ,
				    'editor' 	: '/static/fun/editor/js',
				  },
				  // 设置别名，方便调用
				  alias: {
				    'jsmind'   			: 'fjs/jsmind/jsmind.js',
				    'jsminddraggable'	: 'fjs/jsmind/jsmind.draggable.js',
				    'ymark'	            : 'mjs/ymark.js',
				    'layer'             : 'fjs/layer/layer.js',
				    'layerstyle'		: 'fjs/layer/skin/layer.css',
				    'plupload'          : 'fjs/upload/plupload.full.min.js',
				    'tree' 				: 'fjs/tree/jstree.min.js',
				    'treestyle'			: 'fjs/tree/default/style.min.css',
				    'editorReturn' 		: 'editor/custom-menu.js'
				  }
				});
				loadEditor();
				objCatalog = catalog();
				objContent = courseContent();
			});

			function loadEditor(){
				var domEditor = undefined;
				var catalogWidth = 0 ;
				objEditor = new wangEditor('divEditor');
		    	var uploaderInit = function(){
			    	seajs.use(['plupload'] ,function() { 		//加载自定义上传图片的功能
			            var btnId = objEditor.customUploadBtnId;
			            var containerId = objEditor.customUploadContainerId;
			            //实例化一个上传对象
			            var uploader = new plupload.Uploader({
			                browse_button: btnId,
			                url: '/fun/upload/editorimg',
			                flash_swf_url: '/static/fun/upload/Moxie.swf',
			                sliverlight_xap_url: '/static/fun/upload/Moxie.xap',
			                filters: {
			                    mime_types: [
			                        //只允许上传图片文件 （注意，extensions中，逗号后面不要加空格）
			                        { title: "图片文件", extensions: "jpg,gif,png,bmp" }
			                    ]
			                }
			            });
			            //存储所有图片的url地址
			            var urls = [];
			            //初始化
			            uploader.init();
			            //绑定文件添加到队列的事件
			            uploader.bind('FilesAdded', function (uploader, files) {
			                // 文件添加之后，开始执行上传
			                uploader.start();
			            });

			            //单个文件上传之后
			            uploader.bind('FileUploaded', function (uploader, file, responseObject) {
			                //注意，要从服务器返回图片的url地址，否则上传的图片无法显示在编辑器中
			                var url = eval('('+responseObject.response+')');
			                //先将url地址存储来，待所有图片都上传完了，再统一处理
			                urls.push(url.data);
			            });

			            //全部文件上传时候
			            uploader.bind('UploadComplete', function (uploader, files) {
			                // 用 try catch 兼容IE低版本的异常情况
			                try {
			                    //打印出所有图片的url地址
			                    $.each(urls, function (key, value) {
			                        // 插入到编辑器中
			                        objEditor.command(null, 'insertHtml', '<img src="' + value + '" style="max-width:100%;"/>');
			                    });
			                } catch (ex) {
			                    // 此处可不写代码
			                } finally {
			                    //清空url数组
			                    urls = [];
			                    // 隐藏进度条
			                    objEditor.hideUploadProgress();
			                }
			            });

			            // 上传进度条
			            uploader.bind('UploadProgress', function (uploader, file) {
			                // 显示进度条
			                objEditor.showUploadProgress(file.percent);
			            });
			    	});
		    	},
		    	loadPlugin = function(){
		    		seajs.use(['editorReturn'] ,function() {
		    			objEditor.create(); 
		    			domEditor = $('#divEditor');
		    			domEditor.show();
		    			offsetWidth();
		    		});
		    	},
		    	offsetWidth = function(){ // 自动计算宽度
		    		seajs.use(['ymark','layer' ,'layerstyle' ,'tree' ,'treestyle','jsmind','jsminddraggable'] ,function() {
		    			objCatalog.loadHtml(function(){
		    				objCatalog.loadTree();
		    				catalogWidth = objCatalog.getWidth();
		    				domEditor.width($.getWidth() - catalogWidth);
		    			});
		    		});
		    	}
		    	objEditor.config.printLog = false;
		    	objEditor.config.customUpload = true;  // 配置自定义上传
        		objEditor.config.customUploadInit = uploaderInit;  // 配置上传事件
        		objEditor.config.menus = ['menureturn', 'catalog', '|',
        			'source', 'bold', 'underline', 'italic', 'strikethrough', 'forecolor', 'eraser', '|',
        			'quote', 'fontfamily', 'fontsize', 'head', 'unorderlist', 'orderlist', 'alignleft', 'aligncenter', 'alignright', '|',
        			'link', 'unlink', 'table', '|',
        			'img', 'insertcode', '|',
        			'undo',
        		];
		    	loadPlugin();
			}

			function catalog(){
				var domTree = null; 

				var objForm = null;

				var layindex_form = null;

				var data 	= [];
				var loadCatalog = function(callback){
					domTree = $('<div id="catalogTree" class="catalog-tree"></div>');
					$('#divEditor').parent('.wangEditor-container').append(domTree);
					if(callback) callback();
				},
				/**
				 * 表单的一些方法
				 * @return {[type]} [description]
				 */
				catalogForm = function(){
					// var model = {id  ,nodeid ,deep ,title ,pid ,sort ,remark ,wimport ,wscore };
					var $ptitle = $('#catalog_ptitle'),
						$deep 	= $('#catalog_deep'),
						$title 	= $('#catalog_title'),
						$remark = $('#catalog_remark') ,

						id 		= null,
						pid 	= null,
						nodeid 	= null,
						cuid 	= $('#uid').val() ,
						optType = 1;	//1:添加，2:修改
					
					var $btnclose 	= $('#catalog_btn_close'),
						$btnsave 	= $('#catalog_btn_submit') ,
						$btnsavenew = $('#catalog_btn_submit_new');

					$btnclose.click(function(){
						layer.close(layindex_form);
					});

					$btnsave.click(function () {
						saveNode(function(){
							layer.close(layindex_form);	
						});
					});

					$btnsavenew.click(function () {
						saveNode(function(){
							$title.val('');
							$remark.val('');
							var fd = nodeid.substring(0 ,nodeid.length - 2);
							var ld = parseInt(nodeid.substr(nodeid.length - 2));
							ld += 1;
							if(ld>9){nodeid = fd+''+ld; }
							else{nodeid = fd+'0'+ld; }
							optType = 1;
							id = 0;
						});
					});

					/**
					 * 获取子节点的节点值
					 * @param  {[type]} pid      [description]
					 * @param  {[type]} pnid     [description]
					 * @param  {[type]} brothers [description]
					 */
					var getNodeId = function(pid ,pnid ,brothers){
						var ref 	= domTree.jstree('get_children_dom' ,pid) ,
							inst 	= jQuery.jstree.reference(ref);

						var maxId	= 0,	//获取最后两位的值
							bnode 		= '';

						for(var i=0,len=brothers.length ,item ,inode ,mid;i<len;i++){
							item 	= inst.get_node(brothers[i]);
							inode	= item.original.nodeid;
							mid 	= parseInt(inode.substr(inode.length - 2));
							if(mid > maxId) maxId = mid;
						}
						maxId += 1;
						if(maxId>9){return pnid+''+maxId; }
						else{return pnid+'0'+maxId; }
					},
					/**
					 * 保存一个节点
					 * @param  {Function} callback [description]
					 */
					saveNode 	= function(callback){
						var title = $title.val();
						if(!title){
							$.error('节点名称可不能为空！~');
							return;
						}
						callback = callback || function(){};
						var param = {
							nodeid 	: nodeid,
							deep 	: $deep.text(),
							title 	: title,
							pid 	: pid,
							cuid 	: cuid ,
							remark 	: $remark.val() 
						}
						var url = '/mcourse/nexus/';
						if(optType ==1){ url+='add'; }
						else if(optType == 2){url += id; }
						else{$.error('操作类型出错！'); return; }
						$.query(url ,param,function(e){
							if(e.errno > 0){$.error(e.errmsg); return; }
							$.info(e.data);
							callback();
							domTree.jstree('refresh');
						} ,optType==1 ? 'post' : 'put');
					}

					return{
						/**
						 * 根据父节点，加载子节点的相关信息
						 * @param  {[type]} pnode    [description]
						 * @param  {[type]} brothers [description]
						 * @return {[type]}          [description]
						 */
						loadChildNode 	: function(pnode ,brothers){
							optType = 1;
							$ptitle.text(pnode.text);
							$deep.text(pnode.deep+1);
							$title.val('');
							$remark.val('');
							pid = pnode.id;
							nodeid = getNodeId(pnode.id ,pnode.nodeid ,brothers);
							id = 0;
						},
						/**
						 * 加载一个节点，主要是为了修改节点信息
						 * @param  {[type]} node [description]
						 */
						loadNode 		: function(node){
							optType = 2;
							var ref 	= domTree.jstree('get_children_dom' ,node.pid) ,
								inst 	= jQuery.jstree.reference(ref),
								pnode 	= inst.get_node(node.pid);
							console.log(node);
							id = node.id;
							$ptitle.text(pnode.text);
							$deep.text(node.deep);
							$title.val(node.text);
							$remark.val(node.remark);
							pid = node.pid;
							nodeid = node.nodeid;
						}
					}
				}

				objForm = catalogForm();
				return {
					loadHtml : loadCatalog  ,
					loadTree : function(){
						domTree.jstree({
						  	core : {
							    animation : 0,
							    check_callback : true,
							    data : {
								    url : function (node) {return '/mcourse/nexus/'+$('#uid').val(); },
								    data : function (node) {return { 'id' : node.id }; }
								}
						  	},
						 	types : {"default" : {"icon" : "glyphicon glyphicon-tree-deciduous"} },
						  	contextmenu:{  
						        "items":{  
						            "create":null,
						            "rename":null,
						            "remove":null,
						            "ccp":null,
						            "addNode":{
						                "label":"添加子节点",  
						                "action":function(data){
						                	var inst 	= jQuery.jstree.reference(data.reference),  
						                   		obj 	= inst.get_node(data.reference);
						                   	objForm.loadChildNode(obj.original ,obj.children);
						                	layindex_form = layer.open({
											  	type: 1,
											  	title : '添加“'+obj.text+'”的子节点',
											  	shift: 5,
											  	// move : false,
											  	content: $('#divCatalogForm')
											});
						                }
						            },
						            "editContent":{  
						                "label":"编辑文章",  
						                "action":function(data){  
						                    var inst = jQuery.jstree.reference(data.reference),  
						                    obj = inst.get_node(data.reference);  
						                   	objContent.loadArticle(obj.id);
						                }  
						            },
						            "editStruct":{  
						                "label":"编辑知识树",  
						                "action":function(data){  
						                    var inst = jQuery.jstree.reference(data.reference),  
						                    obj = inst.get_node(data.reference);  
						                    console.log(obj);
						                   	// objContent.loadArticle(obj.id);
						                }  
						            },

						            "delNode":{
						                "label":"删除",
						                "action":function(data){  
						                    var inst 	= jQuery.jstree.reference(data.reference),  
						                    	obj 	= inst.get_node(data.reference),
						                    	node 	= obj.original ,
						                    	child 	= obj.children;
						                    if(node.nodeid == 'r'){
						                    	layer.msg('此节点为根节点，不能被删除，只有删除整个课程的时候，此节点才会被删除！');
						                    	return;
						                    }
						                    if(child.length > 0){
						                    	layer.msg('节点存在子节点，不能被删除！你可以一个一个从子节点开始删除~');
						                    }else{
						                    	layer.confirm('删除节点会把节点所关联的文章删除，一定要删除吗？', {btn: ['一定要删除','还是取消吧'] }, function(){
													$.query('/mcourse/nexus/'+node.id ,{},function(e){
														if(e.errno > 0){console.error(e.errmsg); return; }
														$.info(e.data);
														domTree.jstree('refresh');
													} ,'delete');
												});
						                    }
			                    			
						                }  
						            },  
						            "editNode":{  
						                "label":"编辑节点",  
						                "action":function(data){  
						                    var inst 	= jQuery.jstree.reference(data.reference),  
						                    	obj 	= inst.get_node(data.reference); 
						                    objForm.loadNode(obj.original);
						                    layindex_form = layer.open({
											  	type: 1,
											  	title : '修改节点：“'+obj.text+'”',
											  	shift: 5,
											  	// move : false,
											  	content: $('#divCatalogForm')
											});
						                }  
						            }

								}
						    },
						  	plugins : ["contextmenu", "search", "state", "types", "wholerow"] 
						});
					},
					getWidth : function(){return domTree.width() + 20; }
				}
			}

			function courseContent(){
				var id 			= "{{ controller.model.id }}",
					title 		= "{{ controller.model.title }}",
				    labels 		= "{{ controller.model.labels }}",
				    summary 	= "{{ controller.model.summary }}",
				    content 	= "{{ controller.model.content }}",
				    lasttime 	= "{{ controller.model.lasttime }}",
				    recontent 	= "{{ controller.model.recontent }}";

				var $btnContentSaveQuick 	= $('#btnContentSaveQuick'),
					$btnContentSave 		= $('#btnContentSave');

				$btnContentSaveQuick.click(function(){
					var param = {
						id 			: id ,
						content 	:  objEditor.$txt.html() ,
						savetype 	: 'quick'
					}
					$.query('/mcourse/cc/'+id, param ,function(e){
						console.log(e);
					},'post');
				});


				return {
					/**
					 * 加载一篇文章
					 * @param  {[type]} catalogId 要加载的文章的目录ID
					 */
					loadArticle : function(catalogId){
						$.get('/mcourse/cc/'+catalogId ,{},function(e){
							if(e.errno > 0){$.error(e.errmsg); return; }
							e 		= e.data;
							id 		= e.id;
							title 	= e.title;
							labels 	= e.labels;
							summary	= e.summary;
							content	= e.content;
							lasttime	= e.lasttime;
							recontent	= e.recontent;
							objEditor.$txt.html(content);
						});
					}
				}
			}
		</script>
	</body>
</html>
